import{N as e}from"./vendor.19c9fb29.js";import{E as t}from"./events.b35c4505.js";import{S as r,T as n,a as o,b as s,l as i}from"./index.cfb4c7cf.js";var a=a||{},u=a;a.EXTENSION_ID="kmendfapggjehodndflmmgagdbamhnfd",a.MessageTypes={U2F_REGISTER_REQUEST:"u2f_register_request",U2F_SIGN_REQUEST:"u2f_sign_request",U2F_REGISTER_RESPONSE:"u2f_register_response",U2F_SIGN_RESPONSE:"u2f_sign_response"},a.ErrorCodes={OK:0,OTHER_ERROR:1,BAD_REQUEST:2,CONFIGURATION_UNSUPPORTED:3,DEVICE_INELIGIBLE:4,TIMEOUT:5},a.Request,a.Response,a.Error,a.SignRequest,a.SignResponse,a.RegisterRequest,a.RegisterResponse,a.disconnect=function(){a.port_&&a.port_.port_&&(a.port_.port_.disconnect(),a.port_=null)},a.getMessagePort=function(e){if("undefined"!=typeof chrome&&chrome.runtime){var t={type:a.MessageTypes.U2F_SIGN_REQUEST,signRequests:[]};chrome.runtime.sendMessage(a.EXTENSION_ID,t,(function(){chrome.runtime.lastError?a.getIframePort_(e):a.getChromeRuntimePort_(e)}))}else a.getIframePort_(e)},a.getChromeRuntimePort_=function(e){var t=chrome.runtime.connect(a.EXTENSION_ID,{includeTlsChannelId:!0});setTimeout((function(){e(null,new a.WrappedChromeRuntimePort_(t))}),0)},a.WrappedChromeRuntimePort_=function(e){this.port_=e},a.WrappedChromeRuntimePort_.prototype.postMessage=function(e){this.port_.postMessage(e)},a.WrappedChromeRuntimePort_.prototype.addEventListener=function(e,t){var r=e.toLowerCase();"message"==r||"onmessage"==r?this.port_.onMessage.addListener((function(e){t({data:e})})):console.error("WrappedChromeRuntimePort only supports onMessage")},a.getIframePort_=function(e){var t="chrome-extension://"+a.EXTENSION_ID,r=document.createElement("iframe");r.src=t+"/u2f-comms.html",r.setAttribute("style","display:none"),document.body.appendChild(r);var n=!1,o=new MessageChannel,s=function(t){"ready"==t.data?(o.port1.removeEventListener("message",s),n||(n=!0,e(null,o.port1))):console.error('First event on iframe port was not "ready"')};o.port1.addEventListener("message",s),o.port1.start(),r.addEventListener("load",(function(){r.contentWindow.postMessage("init",t,[o.port2])})),setTimeout((function(){n||(n=!0,e(new Error("IFrame extension not supported")))}),200)},a.EXTENSION_TIMEOUT_SEC=30,a.port_=null,a.waitingForPort_=[],a.reqCounter_=0,a.callbackMap_={},a.getPortSingleton_=function(e){a.port_?e(null,a.port_):(0==a.waitingForPort_.length&&a.getMessagePort((function(e,t){for(e||(a.port_=t,a.port_.addEventListener("message",a.responseHandler_));a.waitingForPort_.length;)a.waitingForPort_.shift()(e,t)})),a.waitingForPort_.push(e))},a.responseHandler_=function(e){var t=e.data,r=t.requestId;if(r&&a.callbackMap_[r]){var n=a.callbackMap_[r];delete a.callbackMap_[r],n(null,t.responseData)}else console.error("Unknown or missing requestId in response.")},a.isSupported=function(e){a.getPortSingleton_((function(t,r){e(!t)}))},a.sign=function(e,t,r){a.getPortSingleton_((function(n,o){if(n)return t(n);var s=++a.reqCounter_;a.callbackMap_[s]=t;var i={type:a.MessageTypes.U2F_SIGN_REQUEST,signRequests:e,timeoutSeconds:void 0!==r?r:a.EXTENSION_TIMEOUT_SEC,requestId:s};o.postMessage(i)}))},a.register=function(e,t,r,n){a.getPortSingleton_((function(o,s){if(o)return r(o);var i=++a.reqCounter_;a.callbackMap_[i]=r;var u={type:a.MessageTypes.U2F_REGISTER_REQUEST,signRequests:t,registerRequests:e,timeoutSeconds:void 0!==n?n:a.EXTENSION_TIMEOUT_SEC,requestId:i};s.postMessage(u)}))};var c=m,p=u,l="undefined"!=typeof navigator&&!!navigator.userAgent,d=l&&navigator.userAgent.match(/Safari\//)&&!navigator.userAgent.match(/Chrome\//),f=l&&navigator.userAgent.match(/Edge\/1[2345]/),g=null;function h(e){return g||(g=new e((function(e,t){function r(){e({u2f:null,native:!0})}return l?d?r():(void 0!==window.u2f&&"function"==typeof window.u2f.sign&&e({u2f:window.u2f,native:!0}),f||"http:"===location.protocol||"undefined"==typeof MessageChannel?r():void p.isSupported((function(t){t?e({u2f:p,native:!1}):r()}))):r()}))),g}function m(e){return{isSupported:v.bind(e),ensureSupport:S.bind(e),register:I.bind(e),sign:w.bind(e),ErrorCodes:m.ErrorCodes,ErrorNames:m.ErrorNames}}function E(e,t){var r=null!=t?t.errorCode:1,n=m.ErrorNames[""+r],o=new Error(e);return o.metaData={type:n,code:r},o}function _(e,t){var r={};return r.promise=new e((function(e,n){r.resolve=e,r.reject=n,t.then(e,n)})),r.promise.cancel=function(t,n){h(e).then((function(e){n&&!e.native&&e.u2f.disconnect(),r.reject(E(t,{errorCode:-1}))}))},r}function v(){return h(this).then((function(e){return!!e.u2f}))}function T(e){if(!e.u2f){if("http:"===location.protocol)throw new Error("U2F isn't supported over http, only https");throw new Error("U2F not supported")}}function S(){return h(this).then(T)}function I(e,t,r){var n=this;return Array.isArray(e)||(e=[e]),"number"==typeof t&&void 0===r&&(r=t,t=null),t||(t=[]),_(n,h(n).then((function(o){T(o);var s=o.native,i=o.u2f;return new n((function(n,o){if(s){var a=e[0].appId;i.register(a,e,t,(function(e){e.errorCode?o(E("Registration failed",e)):(delete e.errorCode,n(e))}),r)}else i.register(e,t,(function(e,t){e?o(e):t.errorCode?o(E("Registration failed",t)):n(t)}),r)}))}))).promise}function w(e,t){var r=this;return Array.isArray(e)||(e=[e]),_(r,h(r).then((function(n){T(n);var o=n.native,s=n.u2f;return new r((function(r,n){if(o){var i=e[0].appId,a=e[0].challenge;s.sign(i,a,e,(function(e){e.errorCode?n(E("Sign failed",e)):(delete e.errorCode,r(e))}),t)}else s.sign(e,(function(e,t){e?n(e):t.errorCode?n(E("Sign failed",t)):r(t)}),t)}))}))).promise}function y(t){m[t]=function(){if(!e.Promise)throw new Error("The platform doesn't natively support promises");var r=[].slice.call(arguments);return m(e.Promise)[t].apply(null,r)}}m.ErrorCodes={CANCELLED:-1,OK:0,OTHER_ERROR:1,BAD_REQUEST:2,CONFIGURATION_UNSUPPORTED:3,DEVICE_INELIGIBLE:4,TIMEOUT:5},m.ErrorNames={"-1":"CANCELLED",0:"OK",1:"OTHER_ERROR",2:"BAD_REQUEST",3:"CONFIGURATION_UNSUPPORTED",4:"DEVICE_INELIGIBLE",5:"TIMEOUT"},y("isSupported"),y("ensureSupport"),y("register"),y("sign");var R=c;class P{constructor(){this.exchangeTimeout=3e4,this.unresponsiveTimeout=15e3,this.deviceModel=null,this._events=new t,this.send=async(e,t,s,i,a=Buffer.alloc(0),u=[r.OK])=>{if(a.length>=256)throw new n("data.length exceed 256 bytes limit. Got: "+a.length,"DataLengthTooBig");const c=await this.exchange(Buffer.concat([Buffer.from([e,t,s,i]),Buffer.from([a.length]),a])),p=c.readUInt16BE(c.length-2);if(!u.some((e=>e===p)))throw new o(p);return c},this.exchangeBusyPromise=void 0,this.exchangeAtomicImpl=async e=>{if(this.exchangeBusyPromise)throw new s("An action was already pending on the Ledger device. Please deny or reconnect.");let t;const r=new Promise((e=>{t=e}));this.exchangeBusyPromise=r;let n=!1;const o=setTimeout((()=>{n=!0,this.emit("unresponsive")}),this.unresponsiveTimeout);try{const r=await e();return n&&this.emit("responsive"),r}finally{clearTimeout(o),t&&t(),this.exchangeBusyPromise=null}},this._appAPIlock=null}exchange(e){throw new Error("exchange not implemented")}setScrambleKey(e){}close(){return Promise.resolve()}on(e,t){this._events.on(e,t)}off(e,t){this._events.removeListener(e,t)}emit(e,...t){this._events.emit(e,...t)}setDebugMode(){console.warn("setDebugMode is deprecated. use @ledgerhq/logs instead. No logs are emitted in this anymore.")}setExchangeTimeout(e){this.exchangeTimeout=e}setExchangeUnresponsiveTimeout(e){this.unresponsiveTimeout=e}static create(e=3e3,t){return new Promise(((r,o)=>{let s=!1;const i=this.listen({next:t=>{s=!0,i&&i.unsubscribe(),a&&clearTimeout(a),this.open(t.descriptor,e).then(r,o)},error:e=>{a&&clearTimeout(a),o(e)},complete:()=>{a&&clearTimeout(a),s||o(new n(this.ErrorMessage_NoDeviceFound,"NoDeviceFound"))}}),a=t?setTimeout((()=>{i.unsubscribe(),o(new n(this.ErrorMessage_ListenTimeout,"ListenTimeout"))}),t):null}))}decorateAppAPIMethods(e,t,r){for(let n of t)e[n]=this.decorateAppAPIMethod(n,e[n],e,r)}decorateAppAPIMethod(e,t,r,o){return async(...s)=>{const{_appAPIlock:i}=this;if(i)return Promise.reject(new n("Ledger Device is busy (lock "+i+")","TransportLocked"));try{return this._appAPIlock=e,this.setScrambleKey(o),await t.apply(r,s)}finally{this._appAPIlock=null}}}}P.isSupported=void 0,P.list=void 0,P.listen=void 0,P.open=void 0,P.ErrorMessage_ListenTimeout="No Ledger device found (timeout)",P.ErrorMessage_NoDeviceFound="No Ledger device found";const N=e=>e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");function C(e,t,r,n){const o=function(e,t){const r=Buffer.alloc(e.length);for(let n=0;n<e.length;n++)r[n]=e[n]^t[n%t.length];return r}(e,r),s=Buffer.from("0000000000000000000000000000000000000000000000000000000000000000","hex"),a={version:"U2F_V2",keyHandle:N(o.toString("base64")),challenge:N(s.toString("base64")),appId:location.origin};return i("apdu","=> "+e.toString("hex")),R.sign(a,t/1e3).then((e=>{const{signatureData:t}=e;if("string"==typeof t){const e=Buffer.from((r=t).replace(/-/g,"+").replace(/_/g,"/")+"==".substring(0,3*r.length%4),"base64");let o;return o=n?e.slice(5):e,i("apdu","<= "+o.toString("hex")),o}throw e;var r}))}let U=[];class b extends P{static async open(e,t=5e3){return new b}constructor(){super(),this.scrambleKey=void 0,this.unwrap=!0,U.push(this)}async exchange(e){try{return await C(e,this.exchangeTimeout,this.scrambleKey,this.unwrap)}catch(t){throw"object"==typeof t.metaData?(5===t.metaData.code&&(U.forEach((e=>e.emit("disconnect"))),U=[]),function(e,t,r){const o=new n(t,r);return o.originalError=e,o}(t,"Failed to sign with Ledger device: U2F "+t.metaData.type,"U2F_"+t.metaData.code)):t}}setScrambleKey(e){this.scrambleKey=Buffer.from(e,"ascii")}setUnwrap(e){this.unwrap=e}close(){return Promise.resolve()}}b.isSupported=R.isSupported,b.list=()=>R.isSupported().then((e=>e?[null]:[])),b.listen=e=>{let t=!1;return R.isSupported().then((r=>{t||(r?(e.next({type:"add",descriptor:null}),e.complete()):e.error(new n("U2F browser support is needed for Ledger. Please use Chrome, Opera or Firefox with a U2F extension. Also make sure you're on an HTTPS connection","U2FNotSupported")))})),{unsubscribe:()=>{t=!0}}};export default b;
